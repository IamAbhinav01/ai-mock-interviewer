<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Mock Interview - {{ skill }}</title>
        <link href="/static/css/output.css" rel="stylesheet" />

        <style>
            #output {
                white-space: pre-wrap;
                background-color: #f3f4f6;
                padding: 1rem;
                border-radius: 0.5rem;
                font-family: monospace;
                font-size: 0.9rem;
            }
        </style>
    </head>
    <body class="bg-gray-100 min-h-screen p-8">
        {% if not complete %}
        <div class="max-w-4xl mx-auto bg-white p-8 rounded-lg shadow">
            <h1 class="text-3xl font-bold mb-6 text-center">Interview: {{ skill }}</h1>

            <!-- Question -->
            <div class="mb-6">
                <h2 class="text-lg font-semibold text-gray-800 mb-2">Question:</h2>
                <p id="question-text" class="text-gray-700 bg-gray-100 p-4 rounded">{{ question }}</p>
            </div>

            <!-- Form -->
            <form method="post" action="/interview/{{ skill }}" onsubmit="submitCode(); return true;">
                <input type="hidden" name="index" value="{{ index | default(0) }}" />
                <input type="hidden" name="answer" id="hidden-answer" />

                <!-- Conditional Code Editor -->
                <div id="code-editor-section" class="mb-4 hidden">
                    <label class="block font-medium mb-1">Your Code:</label>
                    <div id="monaco-editor" style="height: 300px; border: 1px solid #ccc"></div>

                    <div class="mt-4">
                        <label class="block font-medium mb-1">Output:</label>
                        <div id="output" class="min-h-[100px] border border-gray-300"></div>
                    </div>

                    <div class="mt-4">
                        <button
                            type="button"
                            onclick="runCode()"
                            class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700"
                        >
                            ‚ñ∂Ô∏è Run Code
                        </button>
                    </div>
                </div>

                <!-- Fallback Textarea -->
                <div class="mb-4" id="text-answer-section">
                    <label class="block font-medium mb-1" for="answer">Your Answer</label>
                    <textarea
                        name="text-answer"
                        id="answer"
                        rows="4"
                        class="w-full border border-gray-400 p-3 rounded resize-none"
                        placeholder="Type your answer here..."
                    ></textarea>
                </div>

                <!-- Buttons -->
                <div class="flex justify-between items-center mb-6">
                    <div class="flex gap-4">
                        <button
                            type="button"
                            class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300"
                            onclick="startSpeechToText()"
                        >
                            üéôÔ∏è Record Voice
                        </button>
                        <button
                            type="button"
                            onclick="startWebcam()"
                            class="bg-gray-200 text-gray-800 px-4 py-2 rounded hover:bg-gray-300"
                        >
                            üì∏ Take Snapshot
                        </button>
                    </div>
                    <button
                        type="submit"
                        class="bg-blue-600 text-white font-semibold py-2 px-6 rounded hover:bg-blue-700"
                    >
                        {{ 'Finish' if (index | default(0)) + 1 == total else 'Next' }}
                    </button>
                </div>
            </form>

            {% if feedback %}
            <div class="mt-6 bg-green-100 text-green-800 p-4 rounded shadow">
                <h3 class="font-semibold mb-2">LLM Feedback:</h3>
                <p>{{ feedback }}</p>
            </div>
            {% endif %}
        </div>
        {% else %}
        <div class="max-w-2xl mx-auto bg-white p-8 rounded-lg shadow text-center">
            <h2 class="text-3xl font-bold mb-4 text-green-700">üéâ Interview Completed</h2>
            <p class="text-lg text-gray-700 mb-6">
                You have completed the interview on <strong>{{ skill }}</strong>. Great work!
            </p>
            <p class="text-sm text-gray-500 mb-8">Total Questions: <span id="total-questions">{{ total }}</span></p>
            <div class="flex justify-center gap-4">
                <a href="/back-to-dashboard" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                    üîÅ Back to Dashboard
                </a>
                <a href="/interview/{{ skill }}" class="bg-gray-300 text-gray-800 px-6 py-2 rounded hover:bg-gray-400">
                    üîÑ Restart
                </a>
            </div>
        </div>
        {% endif %}

        <!-- Scripts -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs/loader.min.js"></script>
        <script>
            // Dynamically detect coding question
            const question = document.getElementById("question-text").innerText.toLowerCase();
            const isCoding =
                question.includes("code") || question.includes("function") || question.includes("algorithm");

            if (isCoding) {
                document.getElementById("code-editor-section").classList.remove("hidden");
                document.getElementById("text-answer-section").classList.add("hidden");
            }

            // Monaco loader
            require.config({paths: {vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.33.0/min/vs"}});
            let editor;
            require(["vs/editor/editor.main"], function () {
                editor = monaco.editor.create(document.getElementById("monaco-editor"), {
                    value: "# Write your code here\n",
                    language: "python",
                    theme: "vs-dark",
                    automaticLayout: true,
                });
            });

            async function runCode() {
                const code = editor.getValue();
                const outputEl = document.getElementById("output");

                outputEl.innerText = "‚è≥ Running...";

                const response = await fetch("/run-python", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({code}),
                });

                const result = await response.json();
                outputEl.innerText = result.output || "No output";
            }

            function submitCode() {
                if (editor) {
                    document.getElementById("hidden-answer").value = editor.getValue();
                } else {
                    document.getElementById("hidden-answer").value = document.getElementById("answer").value;
                }
            }

            // Speech Recognition
            function setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) {
                    alert("‚ö†Ô∏è Your browser does not support speech recognition.");
                    return null;
                }
                const recog = new SpeechRecognition();
                recog.lang = "en-US";
                recog.interimResults = false;
                recog.maxAlternatives = 1;
                return recog;
            }

            function startSpeechToText() {
                const recognition = setupSpeechRecognition();
                if (!recognition) return;
                recognition.onstart = () => alert("üé§ Speak now...");
                recognition.onerror = (event) => alert("‚ùå Error: " + event.error);
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById("answer").value = transcript;
                };
                recognition.start();
            }

            // Webcam Snapshot
            async function startWebcam() {
                const video = document.getElementById("webcam");
                const canvas = document.getElementById("snapshot-canvas");
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({video: true});
                    video.srcObject = stream;
                    document.getElementById("webcam-container").classList.remove("hidden");
                    setTimeout(() => {
                        const ctx = canvas.getContext("2d");
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                        canvas.classList.remove("hidden");
                        stream.getTracks().forEach((track) => track.stop());
                        video.srcObject = null;
                    }, 1500);
                } catch (err) {
                    alert("‚ö†Ô∏è Could not access webcam.");
                }
            }
        </script>
    </body>
</html>
